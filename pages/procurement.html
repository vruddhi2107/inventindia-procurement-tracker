<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProcureOps â€” Procurement Manager</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
<div id="navbarMount"></div>
<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><span style="font-family:var(--font-mono);font-size:0.8rem;color:var(--gray-4)">Loading...</span></div>

<main class="page-container">
  <div class="page-header">
    <div style="display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:16px">
      <div>
        <h1 class="page-title">Procurement <span>Manager</span></h1>
        <p class="page-sub">Manage quotations, approvals, and order placements</p>
      </div>
      <button class="btn btn-secondary" onclick="loadRequests()">â†» Refresh</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-card-value" id="statNew">â€”</div><div class="stat-card-label">New Requests</div><div class="stat-card-icon">ðŸ“¬</div></div>
    <div class="stat-card" style="--accent:#f59e0b"><div class="stat-card-value" id="statQuoted">â€”</div><div class="stat-card-label">Awaiting Review</div><div class="stat-card-icon">ðŸ“Ž</div></div>
    <div class="stat-card" style="--accent:#22c55e"><div class="stat-card-value" id="statApproved">â€”</div><div class="stat-card-label">Approved to Order</div><div class="stat-card-icon">âœ…</div></div>
    <div class="stat-card" style="--accent:#3b82f6"><div class="stat-card-value" id="statOrdered">â€”</div><div class="stat-card-label">Orders Placed</div><div class="stat-card-icon">ðŸ›’</div></div>
    <div class="stat-card" style="--accent:#f97316"><div class="stat-card-value" id="statGRN">â€”</div><div class="stat-card-label">GRN Pending</div><div class="stat-card-icon">ðŸ“¦</div></div>
    <div class="stat-card" style="--accent:#22c55e"><div class="stat-card-value" id="statClosed">â€”</div><div class="stat-card-label">Closed</div><div class="stat-card-icon">âœ”</div></div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('inbox')">ðŸ“¬ Inbox</button>
    <button class="tab-btn" onclick="switchTab('action')">ðŸ”” Needs Action</button>
    <button class="tab-btn" onclick="switchTab('all')">All Requests</button>
  </div>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search requests..." oninput="filterRequests()"/>
    <select id="filterPhase" onchange="filterRequests()">
      <option value="">All Phases</option>
      <option value="submitted">New â€” Submitted</option>
      <option value="quotation_attached">Quotation Attached</option>
      <option value="approved">Approved â€” Place Order</option>
      <option value="order_placed">Order Placed</option>
      <option value="grn_pending">GRN Pending</option>
      <option value="accepted">Accepted</option>
      <option value="rejected">Rejected</option>
    </select>
    <select id="filterDept" onchange="filterRequests()">
      <option value="">All Departments</option>
      <option value="mech">Mechanical</option>
      <option value="id">Industrial Design</option>
      <option value="electronics">Electronics</option>
    </select>
    <button class="btn btn-ghost btn-sm" onclick="clearFilters()">âœ• Clear</button>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr><th>PR #</th><th>Project / Phase</th><th>Dept</th><th>Category</th><th>Order Type</th><th>Phase</th><th>Submitted</th><th>Requester</th><th>Actions</th></tr>
        </thead>
        <tbody id="requestsBody"><tr><td colspan="9" style="text-align:center;padding:40px;color:var(--gray-4)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</main>

<!-- PR ACTION MODAL -->
<div class="modal-overlay" id="prModal">
  <div class="modal" style="max-width:800px">
    <div class="modal-header">
      <div><div class="modal-title" id="prModalTitle">Request Details</div><div class="modal-title-sub" id="prModalSub"></div></div>
      <button class="modal-close" onclick="closeModal('prModal')">âœ•</button>
    </div>
    <div class="modal-body" id="prModalBody" style="max-height:74vh;overflow-y:auto"></div>
    <div class="modal-footer" id="prModalFooter"><button class="btn btn-secondary" onclick="closeModal('prModal')">Close</button></div>
  </div>
</div>

<div id="toast-container"></div>
<div id="footerMount"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../js/supabase-config.js"></script>
<script src="../js/shared.js"></script>
<script>
let currentUser, allRequests = [], activeTab = 'inbox', currentPR = null;

async function init() {
  currentUser = Session.require(['procurement_manager']);
  if (!currentUser) return;
  document.getElementById('navbarMount').innerHTML = buildNavbar(currentUser);
  document.getElementById('footerMount').innerHTML = buildFooter();
  initNavbar(currentUser);
  showLoader(true);
  await loadRequests();
  showLoader(false);
}

async function loadRequests() {
  const { data } = await db.from('procurement_requests')
    .select('*, users!procurement_requests_created_by_fkey(name,email)')
    .order('created_at', { ascending: false });
  allRequests = data || [];
  updateStats();
  filterRequests();
}

function updateStats() {
  document.getElementById('statNew').textContent = allRequests.filter(r=>r.phase==='submitted').length;
  document.getElementById('statQuoted').textContent = allRequests.filter(r=>r.phase==='engineer_review').length;
  document.getElementById('statApproved').textContent = allRequests.filter(r=>r.phase==='approved').length;
  document.getElementById('statOrdered').textContent = allRequests.filter(r=>r.phase==='order_placed').length;
  document.getElementById('statGRN').textContent = allRequests.filter(r=>r.phase==='grn_pending').length;
  document.getElementById('statClosed').textContent = allRequests.filter(r=>['accepted','rejected'].includes(r.phase)).length;
}

const INBOX_PHASES = ['submitted'];
const ACTION_PHASES = ['approved']; // Can also place order or invoke GRN

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',['inbox','action','all'][i]===tab));
  filterRequests();
}

function clearFilters() {
  document.getElementById('searchInput').value='';
  document.getElementById('filterPhase').value='';
  document.getElementById('filterDept').value='';
  filterRequests();
}

function filterRequests() {
  const s = document.getElementById('searchInput').value.toLowerCase();
  const ph = document.getElementById('filterPhase').value;
  const dp = document.getElementById('filterDept').value;
  let reqs = allRequests;
  if (activeTab==='inbox') reqs = reqs.filter(r=>INBOX_PHASES.includes(r.phase));
  if (activeTab==='action') reqs = reqs.filter(r=>['approved'].includes(r.phase));
  if (s) reqs = reqs.filter(r=>r.project_name.toLowerCase().includes(s)||String(r.request_number).includes(s)||(r.users?.name||'').toLowerCase().includes(s));
  if (ph) reqs = reqs.filter(r=>r.phase===ph);
  if (dp) reqs = reqs.filter(r=>r.department===dp);
  renderRequests(reqs);
}

function renderRequests(reqs) {
  const tbody = document.getElementById('requestsBody');
  if (!reqs.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">${activeTab==='inbox'?'ðŸ“­':'ðŸŽ‰'}</div><h3>${activeTab==='inbox'?'No new requests':'No actions pending'}</h3><p>${activeTab==='inbox'?'All requests have been processed.':'All approved requests have been ordered!'}</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = reqs.map(r => {
    const isNew = r.phase==='submitted';
    const isAction = r.phase==='approved';
    return `<tr style="${isNew||isAction?'background:rgba(224,32,32,0.02)':''}">
      <td><span class="pr-number">PR-${String(r.request_number).padStart(4,'0')}</span>${isNew?'<span style="margin-left:6px;font-size:0.65rem;background:#3b82f6;color:white;padding:1px 6px;border-radius:3px;font-family:var(--font-mono)">NEW</span>':''}</td>
      <td><strong>${r.project_name}</strong><br/><span style="font-size:0.75rem;color:var(--gray-4)">${r.project_phase}</span></td>
      <td style="font-size:0.82rem">${DEPARTMENTS[r.department]||r.department}</td>
      <td class="mono">${r.request_category}</td>
      <td style="font-size:0.78rem;max-width:120px">${ORDER_TYPES[r.order_type]||r.order_type}</td>
      <td>${getPhaseBadge(r.phase)}</td>
      <td class="mono" style="font-size:0.78rem">${formatDate(r.created_at)}</td>
      <td style="font-size:0.82rem">${r.users?.name||'â€”'}</td>
      <td><button class="btn ${isNew||isAction?'btn-primary':'btn-ghost'} btn-sm" onclick='openPR("${r.id}")'>${isNew?'Process':'View'}</button></td>
    </tr>`;
  }).join('');
}

async function openPR(id) {
  currentPR = allRequests.find(r=>r.id===id);
  if (!currentPR) return;
  document.getElementById('prModalTitle').textContent = `PR-${String(currentPR.request_number).padStart(4,'0')} â€” ${currentPR.project_name}`;
  document.getElementById('prModalSub').textContent = `${currentPR.request_category} Â· ${DEPARTMENTS[currentPR.department]} Â· Submitted by ${currentPR.users?.name||'â€”'}`;

  const comments = await loadComments(id);
  let actionSection = '';
  const footer = document.getElementById('prModalFooter');
  footer.innerHTML = `<button class="btn btn-secondary" onclick="closeModal('prModal')">Close</button>`;

  // SUBMITTED: Attach quotation
  if (currentPR.phase === 'submitted') {
    actionSection = `
      <div class="action-section">
        <div class="action-section-title">ðŸ“Ž Attach Quotation <span class="action-badge">ACTION REQUIRED</span></div>
        <p style="font-size:0.85rem;color:var(--gray-3);margin-bottom:14px">Review the request and attach the vendor quotation. This will be sent to the engineer for review.</p>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label">Quotation File URL *</label>
          <input class="form-control" id="quotationUrl" placeholder="https://... (link to quotation PDF or doc)"/>
          <div class="form-hint" style="margin-top:4px">Upload to storage and paste the URL, or use a shared drive link</div>
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label">Quotation Notes</label>
          <textarea class="form-control" id="quotationNotes" placeholder="Summary of quotation, pricing, lead times, vendor comments..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Comment for Engineer</label>
          <textarea class="form-control" id="procNote" placeholder="Instructions or notes for the engineer reviewing this quotation..."></textarea>
        </div>
      </div>`;
    footer.innerHTML = `
      <button class="btn btn-secondary" onclick="closeModal('prModal')">Cancel</button>
      <button class="btn btn-primary" onclick="attachQuotation()">Attach & Send to Engineer â†’</button>`;
  }

  // APPROVED: Place order
  if (currentPR.phase === 'approved') {
    actionSection = `
      <div class="action-section">
        <div class="action-section-title">ðŸ›’ Place Order <span class="action-badge">ACTION REQUIRED</span></div>
        <p style="font-size:0.85rem;color:var(--gray-3);margin-bottom:14px">This request has been approved. Place the order with the vendor and record the details below.</p>
        <div class="form-group">
          <label class="form-label">Order Confirmation Notes *</label>
          <textarea class="form-control" id="orderNotes" placeholder="Vendor PO number, order date, expected delivery, tracking info..."></textarea>
        </div>
      </div>`;
    footer.innerHTML = `
      <button class="btn btn-secondary" onclick="closeModal('prModal')">Cancel</button>
      <button class="btn btn-success" onclick="placeOrder()">âœ… Confirm Order Placed â†’</button>`;
  }

  // ORDER_PLACED: Invoke GRN (parts received)
  if (currentPR.phase === 'order_placed') {
    actionSection = `
      <div class="action-section">
        <div class="action-section-title">ðŸ“¦ Goods Received â€” Invoke GRN</div>
        <p style="font-size:0.85rem;color:var(--gray-3);margin-bottom:14px">Have the parts arrived? Invoke the GRN process to trigger engineer quality check.</p>
        <div class="form-group">
          <label class="form-label">GRN Notes</label>
          <textarea class="form-control" id="grnNotes" placeholder="Delivery date, quantities received, any discrepancies..."></textarea>
        </div>
      </div>`;
    footer.innerHTML = `
      <button class="btn btn-secondary" onclick="closeModal('prModal')">Cancel</button>
      <button class="btn btn-primary" onclick="invokeGRN()">ðŸ“¦ Invoke GRN â†’</button>`;
  }

  document.getElementById('prModalBody').innerHTML = buildPRDetailHTML(currentPR) + actionSection +
    `<div style="margin-top:24px;border-top:1.5px solid var(--border);padding-top:18px">
      <div class="section-title" style="margin-bottom:12px">ðŸ’¬ Comments</div>
      <div id="commentsList">${renderComments(comments)}</div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <input class="form-control" id="commentInput" placeholder="Add a comment..." style="flex:1" onkeydown="if(event.key==='Enter')addComment()"/>
        <button class="btn btn-secondary" onclick="addComment()">Post</button>
      </div>
    </div>`;
  openModal('prModal');
}

async function attachQuotation() {
  const url = document.getElementById('quotationUrl').value.trim();
  const notes = document.getElementById('quotationNotes').value.trim();
  const comment = document.getElementById('procNote').value.trim();
  if (!url) { showToast('Please provide quotation URL','error'); return; }
  showLoader(true);
  const { error } = await db.from('procurement_requests').update({
    phase: 'engineer_review', quotation_url: url, quotation_notes: notes||null,
    assigned_procurement_manager: currentUser.id, updated_at: new Date().toISOString()
  }).eq('id', currentPR.id);
  if (!error && comment) await postComment(currentPR.id, currentUser.id, comment);
  showLoader(false);
  if (error) { showToast('Error: '+error.message,'error'); return; }
  showToast('Quotation attached! Engineer notified for review.','success');
  closeModal('prModal');
  await loadRequests();
}

async function placeOrder() {
  const notes = document.getElementById('orderNotes').value.trim();
  if (!notes) { showToast('Please add order confirmation notes','error'); return; }
  showLoader(true);
  const { error } = await db.from('procurement_requests').update({
    phase: 'order_placed', updated_at: new Date().toISOString()
  }).eq('id', currentPR.id);
  if (!error) await postComment(currentPR.id, currentUser.id, 'ðŸ›’ Order Placed: ' + notes);
  showLoader(false);
  if (error) { showToast('Error: '+error.message,'error'); return; }
  showToast('Order placed! Tracking order delivery.','success');
  closeModal('prModal');
  await loadRequests();
}

async function invokeGRN() {
  const notes = document.getElementById('grnNotes').value.trim();
  showLoader(true);
  const { error } = await db.from('procurement_requests').update({
    phase: 'grn_pending', grn_notes: notes||null, updated_at: new Date().toISOString()
  }).eq('id', currentPR.id);
  if (!error && notes) await postComment(currentPR.id, currentUser.id, 'ðŸ“¦ GRN Invoked: ' + notes);
  showLoader(false);
  if (error) { showToast('Error: '+error.message,'error'); return; }
  showToast('GRN invoked! Engineer notified for quality check.','success');
  closeModal('prModal');
  await loadRequests();
}

async function addComment() {
  const input = document.getElementById('commentInput');
  const text = input?.value.trim();
  if (!text || !currentPR) return;
  try {
    await postComment(currentPR.id, currentUser.id, text);
    input.value = '';
    const comments = await loadComments(currentPR.id);
    document.getElementById('commentsList').innerHTML = renderComments(comments);
  } catch(e) { showToast('Comment failed','error'); }
}

init();
</script>
</body>
</html>